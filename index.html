<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Presence</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
html, body {
  margin: 0;
  padding: 0;
  background: #05050a;
  overflow: hidden;
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
}
#overlay {
  position: fixed;
  inset: 0;
  background: radial-gradient(circle, #0c0c18, #05050a);
  display: flex;
  align-items: center;
  justify-content: center;
  color: #eaeaea;
  cursor: pointer;
  z-index: 10;
}
#overlay div { text-align: center; }
#overlay h1 { font-weight: 500; letter-spacing: 2px; }
#overlay p  { font-size: 0.85rem; color: #aaa; letter-spacing: 1px; }
canvas { display: block; }
</style>
</head>

<body>
<div id="overlay">
  <div>
    <h1>Tap to begin</h1>
    <p>sound reveals intent</p>
  </div>
</div>

<canvas id="c"></canvas>

<script>
// ==========================
// ðŸ”´ PERSONALIZATION
// ==========================
const HER_NAME   = "Naina";
const HER_MSG    = "this was always for you";
const FINAL_LINE = "and I wanted you to feel it";
// ==========================

const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

let w, h;
function resize() {
  w = canvas.width = window.innerWidth;
  h = canvas.height = window.innerHeight;
}
window.addEventListener("resize", resize);
resize();

// ---------------- AUDIO ----------------
let audioCtx, analyser, dataArray;
let started = false;

document.getElementById("overlay").onclick = async () => {
  document.getElementById("overlay").remove();
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  const src = audioCtx.createMediaStreamSource(stream);
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 256;
  dataArray = new Uint8Array(analyser.frequencyBinCount);
  src.connect(analyser);
  started = true;
};

// ---------------- HEART MATH ----------------
function isInsideHeart(nx, ny) {
  const a = nx*nx + ny*ny - 1;
  return (a*a*a - nx*nx*ny*ny*ny) <= 0;
}

function drawHeart(cx, cy, size, alpha) {
  ctx.save();
  ctx.beginPath();
  const t = size * 0.3;
  ctx.moveTo(cx, cy + size/4);
  ctx.bezierCurveTo(cx, cy, cx - size/2, cy, cx - size/2, cy + t);
  ctx.bezierCurveTo(
    cx - size/2, cy + (size+t)/2,
    cx, cy + (size+t)/2,
    cx, cy + size
  );
  ctx.bezierCurveTo(
    cx, cy + (size+t)/2,
    cx + size/2, cy + (size+t)/2,
    cx + size/2, cy + t
  );
  ctx.bezierCurveTo(cx + size/2, cy, cx, cy, cx, cy + size/4);
  ctx.strokeStyle = `rgba(255,180,200,${alpha})`;
  ctx.lineWidth = 2;
  ctx.stroke();
  ctx.restore();
}

// ---------------- PARTICLES ----------------
class Particle {
  constructor() {
    this.x = Math.random()*w;
    this.y = Math.random()*h;
    this.vx = (Math.random()-0.5)*0.6;
    this.vy = (Math.random()-0.5)*0.6;
    this.size = 2;
    this.settled = false;
  }

  update(energy, settle) {
    if (this.settled) return;

    if (!settle) {
      this.x += this.vx + energy*0.01*(Math.random()-0.5);
      this.y += this.vy + energy*0.01*(Math.random()-0.5);
      if (this.x < 0 || this.x > w) this.vx *= -1;
      if (this.y < 0 || this.y > h) this.vy *= -1;
      return;
    }

    const cx = w/2;
    const cy = h/2 - 40;
    const size = 90;

    const nx = (this.x - cx) / size;
    const ny = (this.y - (cy + size*0.5)) / size;

    if (isInsideHeart(nx, ny)) {
      this.settled = true;
      this.vx = 0;
      this.vy = 0;
      return;
    }

    const dx = cx - this.x;
    const dy = (cy + size*0.6) - this.y;
    this.vx += dx * 0.0008;
    this.vy += dy * 0.0008;

    this.x += this.vx;
    this.y += this.vy;
  }

  draw(warm) {
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.size, 0, Math.PI*2);
    ctx.fillStyle = warm
      ? "rgba(244,180,200,0.8)"
      : "rgba(180,180,255,0.35)";
    ctx.fill();
  }
}

const particles = Array.from({length: 260}, ()=>new Particle());

// ---------------- STATE ----------------
let locked = false;
let revealAt = 0;
let typedChars = 0;
const TYPE_SPEED = 18;
let finished = false;

// ---------------- LOOP ----------------
function animate(ts) {
  ctx.fillStyle = "rgba(5,5,10,0.25)";
  ctx.fillRect(0, 0, w, h);

  let energy = 0;
  if (started) {
    analyser.getByteFrequencyData(dataArray);
    energy = dataArray.reduce((s,v)=>s+v,0) / dataArray.length;
  }

  const revealProgress = Math.min(energy / 30, 1);
  if (revealProgress > 0.8 && !locked) {
    locked = true;
    revealAt = ts;
  }

  particles.forEach(p=>{
    p.update(energy, finished);
    p.draw(locked);
  });

  // NAME (optical center)
  ctx.save();
  ctx.fillStyle = "white";
  ctx.font = "42px system-ui";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillText(locked ? HER_NAME : "stay here", w/2, h/2 + 10);
  ctx.restore();

  // MESSAGE
  if (locked && !finished) {
    const elapsed = (ts - revealAt)/1000;
    if (elapsed > 1.5) {
      typedChars = Math.min(
        HER_MSG.length,
        Math.floor((elapsed-1.5)*TYPE_SPEED)
      );
    }
    ctx.save();
    ctx.fillStyle = "rgba(255,255,255,0.85)";
    ctx.font = "16px system-ui";
    ctx.textAlign = "center";
    ctx.fillText(HER_MSG.slice(0, typedChars), w/2, h/2 + 40);
    ctx.restore();

    if (typedChars === HER_MSG.length) finished = true;
  }

  // FINAL HEART
  if (finished) {
    ctx.save();
    ctx.fillStyle = "rgba(0,0,0,0.35)";
    ctx.fillRect(0,0,w,h);

    const pulse = 0.6 + 0.4*Math.sin(ts/260);
    drawHeart(w/2, h/2 - 40, 90 + pulse*8, pulse);

    ctx.fillStyle = "rgba(255,255,255,0.95)";
    ctx.font = "17px system-ui";
    ctx.textAlign = "center";
    ctx.fillText(FINAL_LINE, w/2, h/2 + 90);
    ctx.restore();
  }

  requestAnimationFrame(animate);
}
requestAnimationFrame(animate);
</script>
</body>
</html>
